@if (isOpen) {
  <div class="modal-overlay" (click)="onBackdropClick($event)">
    <div class="modal-content">
      <div class="modal-header">
        @if (trip) {
          <div class="header-content">
            <h2>{{ modalTitle }}</h2>
            <p class="trip-info">
              {{ trip.name }} - {{ formatDate(trip.startDate) }} to {{ formatDate(trip.endDate) }}
            </p>
          </div>
        }
        <button class="close-button" (click)="closeModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @if (isViewMode && expenseToView) {
          <div class="expense-view">
            <div class="expense-header">
              <h3>{{ getExpenseTypeName(expenseToView.type) }}</h3>
              <div class="expense-actions">
                @if (canShowEditButton()) {
                  <button class="btn-edit" (click)="toggleEditMode()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Edit
                  </button>
                }
              </div>
            </div>

            <div class="expense-details">
              <div class="detail-item">
                <span class="label">Total Price:</span>
                <span class="value">{{ formatCurrency(expenseToView.totalPrice) }}</span>
              </div>

              @switch (expenseToView.type) {
                @case ('CarRental') {
                  @if (isCarRentalExpense(expenseToView)) {
                    <div class="detail-item"><span class="label">Car Name:</span><span class="value">{{ expenseToView.carName }}</span></div>
                    <div class="detail-item"><span class="label">Pick-up Date & Time:</span><span class="value">{{ formatDateTime(expenseToView.pickUpDateTime) }}</span></div>
                    <div class="detail-item"><span class="label">Drop-off Date & Time:</span><span class="value">{{ formatDateTime(expenseToView.dropOffDateTime) }}</span></div>
                    <div class="detail-item"><span class="label">Pick-up Location:</span><span class="value">{{ expenseToView.pickUpLocation }}</span></div>
                    <div class="detail-item"><span class="label">Drop-off Location:</span><span class="value">{{ expenseToView.dropOffLocation }}</span></div>
                  }
                }
                @case ('Hotel') {
                  @if (isHotelExpense(expenseToView)) {
                    <div class="detail-item"><span class="label">Hotel Name:</span><span class="value">{{ expenseToView.hotelName }}</span></div>
                    <div class="detail-item"><span class="label">Hotel Location:</span><span class="value">{{ expenseToView.hotelLocation }}</span></div>
                    <div class="detail-item"><span class="label">Check-in Date:</span><span class="value">{{ formatDateTime(expenseToView.checkInDate) }}</span></div>
                    <div class="detail-item"><span class="label">Check-out Date:</span><span class="value">{{ formatDateTime(expenseToView.checkoutDate) }}</span></div>
                  }
                }
                @case ('Flight') {
                  @if (isFlightExpense(expenseToView)) {
                    <div class="detail-item"><span class="label">Airline:</span><span class="value">{{ expenseToView.airline }}</span></div>
                    <div class="detail-item"><span class="label">From:</span><span class="value">{{ expenseToView.from }}</span></div>
                    <div class="detail-item"><span class="label">To:</span><span class="value">{{ expenseToView.to }}</span></div>
                    <div class="detail-item"><span class="label">Departure Date & Time:</span><span class="value">{{ formatDateTime(expenseToView.departureDateTime) }}</span></div>
                    <div class="detail-item"><span class="label">Arrival Date & Time:</span><span class="value">{{ formatDateTime(expenseToView.arrivalDateTime) }}</span></div>
                  }
                }
                @case ('Taxi') {
                  @if (isTaxiExpense(expenseToView)) {
                    <div class="detail-item"><span class="label">From:</span><span class="value">{{ expenseToView.from }}</span></div>
                    <div class="detail-item"><span class="label">To:</span><span class="value">{{ expenseToView.to }}</span></div>
                    <div class="detail-item"><span class="label">Date & Time:</span><span class="value">{{ formatDateTime(expenseToView.dateTime) }}</span></div>
                  }
                }
              }
            </div>

            @if (canShowEditButton()) {
              <button class="btn-delete" (click)="onDeleteExpense()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Delete
              </button>
            }
          </div>
        }

        @if (!showSuccessMessage && (!expenseToView || isEditMode)) {
          <app-expense-form
            [expenseToEdit]="isEditMode ? expenseToView : null"
            [isEditMode]="isEditMode"
            (expenseCreated)="onExpenseCreated($event)"
            (expenseUpdated)="onExpenseUpdated($event)"
            (cancelled)="onCancelled()"
          ></app-expense-form>
        }
      </div>
    </div>
  </div>
}
